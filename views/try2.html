const attachBtn = document.getElementById('attachBtn');
const attachMenu = document.getElementById('attachMenu');
const filePhoto = document.getElementById('filePhoto');
const fileDocument = document.getElementById('fileDocument');
const fileAudio = document.getElementById('fileAudio');

attachBtn.addEventListener('click', () => {
  attachMenu.style.display = attachMenu.style.display === 'block' ? 'none' : 'block';
});

document.addEventListener('click', (e) => {
  if (!attachMenu.contains(e.target) && e.target !== attachBtn) {
    attachMenu.style.display = 'none';
  }
});

document.querySelectorAll('.attachOption').forEach(button => {
  button.addEventListener('click', () => {
    const type = button.dataset.type;
    attachMenu.style.display = 'none';

    if (type === 'photo') filePhoto.click();
    else if (type === 'document') fileDocument.click();
    else if (type === 'audio') fileAudio.click();
  });
});

// Helper function to upload and show file in chat
async function uploadFile(file, endpoint, messageType) {
  const messageContainer = document.getElementById('chatMessages');

  // Create temp message UI with sending label
  const tempMsgDiv = document.createElement('div');
  tempMsgDiv.className = 'message ' + messageType + ' sending';

  let fileElement;
  if (messageType === 'image') {
    fileElement = document.createElement('img');
    fileElement.src = URL.createObjectURL(file);
    fileElement.style.maxWidth = '150px';
  } else if (messageType === 'document') {
    fileElement = document.createElement('a');
    fileElement.href = '#';
    fileElement.textContent = file.name;
    fileElement.target = '_blank';
  } else if (messageType === 'audio') {
    fileElement = new Audio(URL.createObjectURL(file));
    fileElement.controls = true;
  }

  const statusLabel = document.createElement('small');
  statusLabel.textContent = 'Sending...';
  statusLabel.className = 'sending-label';

  tempMsgDiv.appendChild(fileElement);
  tempMsgDiv.appendChild(statusLabel);
  messageContainer.appendChild(tempMsgDiv);

  // Emit temp socket message with local file preview (optional)
  socket.emit('chat message', {
    content: `[${messageType.charAt(0).toUpperCase() + messageType.slice(1)} message]`,
    file_url: URL.createObjectURL(file),
    file_type: file.type,
    file_name: file.name,
    message_type: messageType,
    sender_id: currentUserId,
    receiver_id: receiverId,
    sender_name: document.getElementById('adminName').textContent,
    chat_type: 'private',
    is_temp: true,
  });

  // Prepare form data
  const formData = new FormData();
  formData.append('file', file);
  formData.append('sender_id', currentUserId);
  formData.append('receiver_id', receiverId);
  formData.append('chat_type', 'private');

  try {
    const res = await fetch(endpoint, {
      method: 'POST',
      body: formData,
    });

    const result = await res.json();

    // Update UI with final file URL and "Sent" label
    if (messageType === 'image') {
      fileElement.src = result.file_url;
    } else if (messageType === 'document') {
      fileElement.href = result.file_url;
    } else if (messageType === 'audio') {
      fileElement.src = result.file_url;
      fileElement.load();
    }

    statusLabel.textContent = 'Sent';
    statusLabel.style.color = 'green';
    tempMsgDiv.classList.remove('sending');

    // Emit socket event with final message info
    socket.emit('chat message', {
      content: `[${messageType.charAt(0).toUpperCase() + messageType.slice(1)} message]`,
      file_url: result.file_url,
      file_type: result.file_type,
      file_name: result.file_name,
      message_type: messageType,
      sender_id: currentUserId,
      receiver_id: receiverId,
      sender_name: document.getElementById('adminName').textContent,
      chat_type: 'private',
    });

  } catch (err) {
    console.error(`${messageType} upload failed:`, err);
    statusLabel.textContent = 'Upload failed';
    statusLabel.style.color = 'red';
  }
}

// File input change handlers
filePhoto.addEventListener('change', (e) => {
  if (e.target.files.length > 0) {
    uploadFile(e.target.files[0], '/api/messages/send/image', 'image');
  }
});

fileDocument.addEventListener('change', (e) => {
  if (e.target.files.length > 0) {
    uploadFile(e.target.files[0], '/api/messages/send/file', 'document');
  }
});

fileAudio.addEventListener('change', (e) => {
  if (e.target.files.length > 0) {
    uploadFile(e.target.files[0], '/api/messages/send/voice', 'audio');
  }
});
