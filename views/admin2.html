<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard with Chat</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background: #f1f5f9;
    }

    /* Top Navbar */
    #topNav {
      height: 56px;
      background-color: #1e293b;
      color: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.2);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1050;
    }

    #topNav .welcome-text {
      font-weight: 600;
      font-size: 1.1rem;
    }

    #profileDropdown {
      color: #f1f5f9;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
      position: relative;
    }

    /* Notification badge before avatar */
    #profileDropdown .notif-badge {
      position: absolute;
      top: 0;
      right: 32px;
      background-color: #ef4444;
      color: white;
      border-radius: 50%;
      font-size: 0.7rem;
      padding: 3px 6px;
      font-weight: 700;
      user-select: none;
      transform: translate(50%, -50%);
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }

    #profileDropdown img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    #profileDropdown .caret {
      border-top: 5px solid #f1f5f9;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      display: inline-block;
      margin-left: 0.2rem;
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 56px;
      left: 0;
      bottom: 0;
      width: 260px;
      background-color: #111827;
      color: #e0e7ff;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow-y: auto;
      box-shadow: 2px 0 6px rgb(0 0 0 / 0.3);
      z-index: 1020;
    }

    #sidebar h5 {
      margin-bottom: 0.75rem;
      font-weight: 700;
      border-bottom: 1px solid #374151;
      padding-bottom: 0.3rem;
    }

    .section {
      margin-bottom: 2rem;
    }

    .list-group-item {
      background: transparent;
      border: none;
      color: #cbd5e1;
      padding-left: 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s ease;
      border-radius: 6px;
    }

    .list-group-item:hover {
      background-color: #374151;
    }

    .list-group-item.active {
      background-color: #2563eb;
      color: white;
    }

    .btn-icon {
      background: none;
      border: none;
      color: #93c5fd;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0 0.3rem;
    }

    #addDepartmentBtn {
      width: 100%;
      margin-top: 0.5rem;
    }

    /* Main Content Area - Split chat list and chat UI */
    #mainContent {
      margin-left: 260px;
      padding: 1rem;
      height: calc(100vh - 56px);
      display: flex;
      gap: 1rem;
      padding-top: 5%;
      overflow: hidden;
    }

    /* Left: Chat List */
    #chatListContainer {
      width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    #chatListContainer h5 {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      margin: 0;
      font-weight: 600;
    }

    #chatList {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
    }

    #chatList li.chat-item {
      padding: 1rem;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #333;
      transition: background-color 0.2s ease;
      user-select: none;
    }

    #chatList li.chat-item:hover {
      background-color: #f3f4f6;
    }

    #chatList li.chat-item.active {
      background-color: #2563eb;
      color: white;
      font-weight: 600;
    }

    /* Right: Chat UI */
    #chatUI {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      overflow: hidden;
    }

    #chatUI header {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      font-weight: 600;
      background-color: #f9fafb;
    }

    #messagesContainer {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      background: #f9fafb;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    #messagesContainer .message {
      margin-bottom: 0.8rem;
      padding: 0.5rem 0.75rem;
      border-radius: 15px;
      max-width: 75%;
      word-wrap: break-word;
      clear: both;
    }

    #messagesContainer .message.admin {
      background-color: #2563eb;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 3px;
    }

    #messagesContainer .message.staff {
      background-color: #e0e7ff;
      color: #1e293b;
      margin-right: auto;
      border-bottom-left-radius: 3px;
    }

    #chatForm {
      display: flex;
      padding: 0.5rem 1rem;
      border-top: 1px solid #ddd;
      background-color: #f9fafb;
      gap: 0.5rem;
    }

    #messageInput {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 20px;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s ease;
    }

    #messageInput:focus {
      border-color: #2563eb;
      box-shadow: 0 0 5px rgba(37, 99, 235, 0.5);
    }

    #sendBtn {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 0 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }

    #sendBtn:hover {
      background-color: #1e40af;
    }
/* Layout */
#mainContent {
  display: flex;
  height: 100vh;
  font-family: 'Segoe UI', sans-serif;
}

#chatListContainer {
  width: 280px;
  background: #f7f7f7;
  border-right: 1px solid #ddd;
  padding: 16px;
  overflow-y: auto;
}

#chatListContainer h3 {
  margin-bottom: 12px;
}

#chatSearch {
  width: 100%;
  padding: 8px;
  margin-bottom: 16px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.chat-group details summary {
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
  margin-bottom: 5px;
}

.chatListGroup {
  list-style: none;
  padding-left: 10px;
}

.chatListGroup li {
  padding: 8px 10px;
  margin-bottom: 4px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.2s ease;
}

.chatListGroup li:hover {
  background-color: #e0e0e0;
}

.chatListGroup li.active {
  background-color: #007bff;
  color: white;
}

/* Chat UI */
#chatUI {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 16px;
  background: #fff;
}

#chatHeader {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 12px;
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
}

#messagesContainer {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  background: #f2f2f2;
  border-radius: 8px;
  margin-bottom: 12px;
}

.message {
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 8px;
  max-width: 70%;
  line-height: 1.4;
}

.admin {
  background-color: #cce5ff;
  align-self: flex-end;
  margin-left: auto;
}

.staff {
  background-color: #e2e2e2;
  align-self: flex-start;
  margin-right: auto;
}

#chatForm {
  display: flex;
  gap: 10px;
}

#messageInput {
  flex: 1;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

#sendBtn {
  padding: 10px 16px;
  background: #007bff;
  border: none;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}

  </style>
</head>
<body>

  <!-- Top Navbar -->
  <nav id="topNav">
    <div class="welcome-text">Welcome, <span id="adminName">Admin</span></div>
    <div id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false" role="button" tabindex="0">
      <!-- Notification badge -->
      <span class="notif-badge" id="profileNotif" style="display:none">3</span>
      <img src="https://i.pravatar.cc/150?img=12" alt="Admin Avatar" />
      <span class="caret"></span>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside id="sidebar">
  <p>cardstel</p>
    <div class="section">
      <h5>Departments</h5>
      <ul id="departmentList" class="list-group list-group-flush">
        <!-- Sample departments -->
     
      </ul>
      <button id="addDepartmentBtn" class="btn btn-primary btn-sm mt-2">+ Add Department</button>
    </div>

    <div class="section">
      <h5>General Chat</h5>
      <ul id="generalChatList" class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Admin
          <span class="badge bg-success rounded-pill">5</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Staff
          <span class="badge bg-danger rounded-pill">2</span>
        </li>
      </ul>
    </div>
    <div class="section">
  <h5>Manage Staff</h5>
  <button class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#addStaffModal">+ Add Staff</button>
</div>
  </aside>

<!-- Main Content -->
<main id="mainContent">
  <!-- Left chat list -->
  <div id="chatListContainer">
  <h3>Chats</h3>

  <!-- Departments -->
  <div class="chat-group">
    <label>Departments</label>
    <input type="text" class="searchInput" data-target="departmentList" placeholder="Search departments..." />
    <ul id="departmentLists" class="chatListGroup">
      <li>HR</li>
      <li>Finance</li>
      <li>Engineering</li>
      <li>Design</li>
    </ul>
  </div>

  <!-- Staff -->
  <div class="chat-group">
    <label>Staff</label>
    <input type="text" class="searchInput" data-target="staffList" placeholder="Search staff..." />
    <ul id="staffList" class="chatListGroup">
      <li>John Doe</li>
      <li>Jane Smith</li>
      <li>Chris James</li>
    </ul>
  </div>

  <!-- Admin -->
  <div class="chat-group">
    <label>Admins</label>
    <input type="text" class="searchInput" data-target="adminList" placeholder="Search admins..." />
    <ul id="adminList" class="chatListGroup">
      <li>Admin Alpha</li>
      <li>Admin Beta</li>
    </ul>
  </div>
</div>


  <!-- Right chat UI -->
  <div id="chatUI">
    <header id="chatHeader">Select a chat</header>
    <div id="messagesContainer"></div>
    <form id="chatForm">
      <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" required />
      <button type="submit" id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
    </form>
  </div>
</main>



<!-- Modal for Adding Staff (with registration link email) -->
<div class="modal fade" id="addStaffModal" tabindex="-1" aria-labelledby="addStaffModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addStaffForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addStaffModalLabel">Add New Staff</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="staffEmail" class="form-label">Email</label>
          <input type="email" class="form-control" id="staffEmail" name="email" required />
        </div>
        <div class="mb-3">
          <label for="staffRole" class="form-label">Role</label>
          <select class="form-select" id="staffRole" name="role" required>
            <option value="staff">Staff</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      <div class="mb-3">
  <label for="staffDepartment" class="form-label">Department (optional)</label>
  <select class="form-select" id="staffDepartment" name="department_id">
    <option value="">-- None --</option>
  </select>
</div>

      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Send Invite</button>
      </div>
    </form>
  </div>
</div>
<!-- Add Department Modal -->
<div class="modal fade" id="addDepartmentModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="addDepartmentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Department</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" id="newDeptName" placeholder="Enter department name" required />
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Department Modal -->
<div class="modal fade" id="editDepartmentModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editDepartmentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Department</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" id="editDeptName" required />
        <input type="hidden" id="editDeptId" />
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- Assign Staff Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="assignForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Staff</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="assignDeptId" />
        <input type="email" class="form-control" id="assignEmail" placeholder="Staff email" required />
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-info">Assign</button>
      </div>
    </form>
  </div>
</div>

<!-- Reusable Success Toast Message -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="successToastBody">
        Operation successful!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
<!-- Error Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="errorToastBody">
        An error occurred.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>




  <!-- Bootstrap JS Bundle (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 <!-- Add these in your HTML <head> or before </body> -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>

<script>
  // üîê Initialize Firebase (replace with your actual config)
     const firebaseConfig = {
      apiKey: "AIzaSyBCnkHghVzYEKhYMncwLQ-IlGLVbfIJt9U",
      authDomain: "chat-app-6776e.firebaseapp.com",
      projectId: "chat-app-6776e",
      storageBucket: "chat-app-6776e.firebasestorage.app",
      messagingSenderId: "136411415099",
      appId: "1:136411415099:web:37f7c2c9cb4431db27121e",
      measurementId: "G-GVS3VG6Y50"
    };
    
  firebase.initializeApp(firebaseConfig);
</script>

<script>
  // Wait until Firebase auth is ready
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      alert("You must be logged in.");
      return;
    }

    const token = await user.getIdToken();

    // üåê Connect to Socket.IO with Firebase token
    const socket = io({
      auth: {
        token: token
      }
    });

    // ‚úÖ Receive message from server
    socket.on('chat message', (data) => {
      console.log("New message received:", data);
      renderMessage(data); // update the UI
    });

    // ‚úâÔ∏è Send message on form submit
    document.getElementById('chatForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();

      if (!msg) return;

      socket.emit('chat message', {
        content: msg,
        type: 'department' // 'private', 'broadcast' as needed
      });

      input.value = '';
    });

    // üßæ Render message in UI
    function renderMessage({ content, senderId, isSelf }) {
      const container = document.getElementById('messagesContainer');
      const div = document.createElement('div');
      div.className = 'message ' + (isSelf ? 'admin' : 'staff');
      div.textContent = content;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
  });
</script>

 
 
 <script>
function showSuccess(message = "Success!") {
  document.getElementById('successToastBody').textContent = message;
  new bootstrap.Toast(document.getElementById('successToast')).show();
}

function showError(message = "Something went wrong.") {
  document.getElementById('errorToastBody').textContent = message;
  new bootstrap.Toast(document.getElementById('errorToast')).show();
}


async function populateDepartmentDropdown() {
    try {
      const res = await fetch('/api/departments');
      const departments = await res.json();

      const select = document.getElementById('staffDepartment');
      select.innerHTML = '<option value="">-- None --</option>'; // Reset

      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.id;
        option.textContent = dept.name;
        select.appendChild(option);
      });
    } catch (err) {
      console.error("Failed to load departments:", err);
    }
  }

  // Optional: When modal is shown, load departments
  const addStaffModal = document.getElementById('addStaffModal');
  addStaffModal.addEventListener('show.bs.modal', populateDepartmentDropdown);

 document.getElementById('addStaffForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const email = document.getElementById('staffEmail').value.trim();
  const role = document.getElementById('staffRole').value;
  const department_id = document.getElementById('staffDepartment').value || null;

  try {
    const response = await fetch('/api/staff/invite', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email, role, department_id })
    });

    let resultText = await response.text(); // <-- get text first

    // Try to parse JSON
    let result;
    try {
      result = JSON.parse(resultText);
    } catch (jsonError) {
      throw new Error('Server returned non-JSON: ' + resultText.slice(0, 100));
    }

    if (response.ok) {
      showSuccess("Invitation email sent successfully!");
      document.getElementById('addStaffForm').reset();
      const modal = bootstrap.Modal.getInstance(document.getElementById('addStaffModal'));
      modal.hide();
    } else {
      const errorMessage = result.error || result.message || 'Something went wrong';
      alert('Error: ' + errorMessage);
    }

  } catch (err) {
    alert('Network or unexpected error: ' + err.message);
    console.error(err);
  }
});

</script>

  
  <script>
    // Sample user data
    const adminName = "Admin";

    // Set admin name in top nav
    document.getElementById('adminName').textContent = adminName;
const staffDepartmentSelect = document.getElementById('staffDepartment');
const departmentList = document.getElementById('departmentList');

const API_BASE = window.location.hostname === 'localhost'
  ? 'http://localhost:5000/api/departments'
  : 'https://cardstel.onrender.com/api/departments';

// Load departments from backend and display them
async function loadDepartments() {
  try {
    const res = await fetch(API_BASE);
    const departments = await res.json();

    // Clear previous content
    staffDepartmentSelect.innerHTML = '';
    departmentList.innerHTML = '';

    departments.forEach(dep => renderDepartment(dep));
  } catch (err) {
    console.error('Failed to load departments:', err);
  }
}

// Render a department item into both the list and dropdown
function renderDepartment(dept) {
  // Create list item
  const li = document.createElement('li');
  li.className = "list-group-item d-flex justify-content-between align-items-center";
  li.dataset.deptId = dept.id;

  const span = document.createElement('span');
  span.textContent = dept.name;
  li.appendChild(span);

  const btnGroup = document.createElement('div');

  // Edit button
  const btnEdit = document.createElement('button');
  btnEdit.className = "btn-icon";
  btnEdit.title = "Edit";
  btnEdit.innerHTML = '<i class="fas fa-pen text-warning"></i>';
  btnEdit.addEventListener('click', () => {
    document.getElementById('editDeptName').value = dept.name;
    document.getElementById('editDeptId').value = dept.id;
    new bootstrap.Modal(document.getElementById('editDepartmentModal')).show();
  });

  // Assign button
  const btnAssign = document.createElement('button');
  btnAssign.className = "btn-icon";
  btnAssign.title = "Assign Staff";
  btnAssign.innerHTML = '<i class="fas fa-user-plus text-primary"></i>';
  btnAssign.addEventListener('click', () => {
    document.getElementById('assignDeptId').value = dept.id;
    document.getElementById('assignEmail').value = '';
    new bootstrap.Modal(document.getElementById('assignModal')).show();
  });

  // Delete button
  const btnRemove = document.createElement('button');
  btnRemove.className = "btn-icon";
  btnRemove.title = "Delete";
  btnRemove.innerHTML = '<i class="fas fa-trash text-danger"></i>';
  btnRemove.addEventListener('click', async () => {
    if (confirm(`Delete "${dept.name}"?`)) {
      try {
        await fetch(`${API_BASE}/${dept.id}`, { method: 'DELETE' });
        li.remove();
        const optionToRemove = staffDepartmentSelect.querySelector(`option[value="${dept.id}"]`);
        if (optionToRemove) optionToRemove.remove();
      } catch (err) {
        console.error('Error deleting department:', err);
      }
    }
  });

  btnGroup.append(btnEdit, btnAssign, btnRemove);
  li.appendChild(btnGroup);
  departmentList.appendChild(li);

  // Add to dropdown
  const option = document.createElement('option');
  option.value = dept.id;
  option.textContent = dept.name;
  staffDepartmentSelect.appendChild(option);
}

// Add new department
document.getElementById('addDepartmentForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const name = document.getElementById('newDeptName').value.trim();
  if (!name) return showError("Department name is required.");

  try {
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });

    const data = await res.json();

    if (res.ok) {
      renderDepartment(data);
      bootstrap.Modal.getInstance(document.getElementById('addDepartmentModal')).hide();
      showSuccess("Department added successfully!");
    } else {
      showError(data.message || "Failed to add department.");
    }
  } catch (err) {
    console.error("Add department error:", err);
    showError("Network error. Please try again.");
  }
});

// Edit department
document.getElementById('editDepartmentForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const id = document.getElementById('editDeptId').value;
  const name = document.getElementById('editDeptName').value.trim();
  if (!name) return showError("Department name cannot be empty.");

  try {
    const res = await fetch(`${API_BASE}/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });

    const data = await res.json();

    if (res.ok) {
      await loadDepartments();
      bootstrap.Modal.getInstance(document.getElementById('editDepartmentModal')).hide();
      showSuccess("Department updated successfully!");
    } else {
      showError(data.message || 'Failed to update department');
    }
  } catch (err) {
    console.error("Update error:", err);
    showError("Network error. Please try again.");
  }
});

// Assign staff
document.getElementById('assignForm').addEventListener('submit', async function (e) {
  e.preventDefault();
  const email = document.getElementById('assignEmail').value.trim();
  const department_id = document.getElementById('assignDeptId').value;

  if (!email || !department_id) return showError("Both email and department are required.");

  try {
    const res = await fetch('/api/staff-assign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, department_id })
    });

    const data = await res.json();

    if (res.ok) {
      showSuccess("Staff assigned successfully!");
      bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
    } else {
      showError(data.message || "Failed to assign staff.");
    }
  } catch (err) {
    console.error("Assignment error:", err);
    showError("Network error. Please try again.");
  }
});

// Show Add Department modal
document.getElementById('addDepartmentBtn').addEventListener('click', () => {
  document.getElementById('newDeptName').value = '';
  new bootstrap.Modal(document.getElementById('addDepartmentModal')).show();
});

// Init
window.addEventListener('DOMContentLoaded', loadDepartments);





  </script>
</body>
</html>
