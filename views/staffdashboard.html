<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chaty Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --primary: #075e54;
      --secondary: #25d366;
      --chat-bg: #ece5dd;
      --sidebar-bg: #ffffff;
      --msg-recv: #ffffff;
      --msg-sent: #dcf8c6;
      --text-color: #303030;
      --muted-text: #888;
      --modal-bg: rgba(0,0,0,0.5);
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family:'Inter',sans-serif; background:var(--chat-bg); color:var(--text-color); }
    #chatContainer { display:flex; height:100vh; overflow:hidden; }

    /* Sidebar */
    #sidebar { width:300px; background:var(--sidebar-bg); border-right:1px solid #ddd; display:flex; flex-direction:column; }
    .header { padding:1rem; background:var(--primary); color:#fff; display:flex; align-items:center; font-weight:600; }
    .header .logo { width:32px; height:32px; margin-right:8px; }
    .chat-section { border-bottom:1px solid #eee; }
    .chat-section-title { padding:0.75rem 1rem; font-weight:600; background:#f0f2f5; display:flex; justify-content:space-between; cursor:pointer; transition:background 0.3s; }
    .chat-section-title:hover { background:#e4e6eb; }
    .chat-list { overflow:hidden; transition:height 0.3s ease; }
    .chat-item { display:flex; padding:1rem; cursor:pointer; border-bottom:1px solid #f1f1f1; }
    .chat-item img { width:45px; height:45px; border-radius:50%; margin-right:1rem; }
    .badge { background:var(--secondary); color:#fff; font-size:0.7rem; padding:2px 6px; border-radius:10px; margin-left:8px; }

    /* Custom scrollbar */
    #sidebar::-webkit-scrollbar { width:6px; }
    #sidebar::-webkit-scrollbar-thumb { background:#ccc; border-radius:3px; }

    /* Chat View */
    #chatView { flex:1; display:flex; flex-direction:column; background:var(--chat-bg); transition:left 0.3s ease; position:relative; }
    #chatHeader { padding:1rem; background:var(--primary); color:#fff; display:flex; align-items:center; gap:1rem; position:relative; }
    #chatHeader .back-btn { display:none; font-size:1.2rem; cursor:pointer; }
    #chatHeader .chat-logo { width:40px; height:40px; border-radius:50%; }
    #chatHeader .controls { margin-left:auto; display:flex; gap:16px; }
    #chatHeader .controls i { cursor:pointer; font-size:1.25rem; }

    /* Messages area */
    #messages { flex:1; overflow-y:auto; padding:1rem; display:flex; flex-direction:column; gap:0.7rem; }
    .message { max-width:70%; padding:0.7rem 1rem; border-radius:1rem; box-shadow:0 2px 5px rgba(0,0,0,0.1); animation:slideIn 0.3s ease; position:relative; }
    @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0);} }
    .recv { background:var(--msg-recv); align-self:flex-start; border-bottom-left-radius:0; }
    .sent { background:var(--msg-sent); align-self:flex-end; border-bottom-right-radius:0; }

    .time { font-size:0.75rem; color:var(--muted-text); margin-top:4px; text-align:right;}
    .seen-status { position:absolute; bottom:4px; right:8px; font-size:0.75rem; color:#4fc3f7;}

    /* Input form */
    #chatForm { display:flex; padding:0.75rem 1rem; align-items:center; background:#fff; border-top:1px solid #ccc; gap:0.5rem; }
    #chatForm i.fa-microphone { font-size:1.4rem; color:var(--primary); cursor:pointer; }
    #chatInput { flex:1; padding:0.6rem 1rem; border:1px solid #ccc; border-radius:20px; }
    #sendBtn { background:var(--secondary); color:#fff; border:none; width:42px; height:42px; border-radius:50%; font-size:1.2rem; cursor:pointer; }

    /* Search Modal */
    #searchModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--modal-bg); align-items:center; justify-content:center; }
    #searchModal .modal-content { background:#fff; padding:1.5rem; border-radius:8px; width:90%; max-width:360px; display:flex; flex-direction:column; gap:1rem; }
    #searchModal input { padding:0.6rem 1rem; border:1px solid #ccc; border-radius:8px; width:100%; }
    #searchModal button { align-self:flex-end; padding:0.5rem 1rem; background:var(--secondary); border:none; color:#fff; border-radius:6px; }

    @media(max-width:768px) {
      #chatContainer { flex-direction:column; }
      #sidebar { width:100%; }
      #chatView { position:absolute; width:100%; height:100%; top:0; left:100%; z-index:5; }
      #chatView.active { left:0; }
      #chatHeader .back-btn { display:inline; }
    }

     /* Add this in your main CSS or inside a <style> tag */
  .chat-input-wrapper {
    position: relative;
    flex-grow: 1;
  }

  .chat-input-wrapper input {
    padding-right: 40px; /* make space for mic icon */
  }

  .chat-input-wrapper .mic-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #888;
    cursor: pointer;
  }

  #chatForm {
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
  }

  #chatForm input {
    border-radius: 25px;
    padding-left: 15px;
    border: 1px solid #ced4da;
  }

  #chatForm .fa-paperclip {
    font-size: 1.2rem;
    cursor: pointer;
  }

  #chatForm .btn {
    width: 40px;
    height: 40px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chat-header {
  background-color: #f5f7fa;
  height: 60px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.chat-logo {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.name {
  font-size: 16px;
  color: #333;
}

.controls i {
  font-size: 18px;
  color: #555;
  cursor: pointer;
}

.back-btn {
  font-size: 20px;
  color: #333;
  cursor: pointer;
}
.rotate-icon {
  transition: transform 0.3s ease;
}
.rotate-icon.collapsed {
  transform: rotate(-90deg);
}

  </style>
</head>
<body>
  <div id="chatContainer">
    <div id="sidebar">
      <div class="header">
        <img class="logo" src="https://via.placeholder.com/40.png?text=Logo" alt="Logo"/>
        CompanyName
      </div>
<!-- Department Group Chats Section -->
<div class="chat-section">
  <div class="chat-section-title d-flex justify-content-between align-items-center"
       data-bs-toggle="collapse"
       data-bs-target="#departmentCollapse"
       role="button"
       aria-expanded="true"
       aria-controls="departmentCollapse">
    <span>Department Group Chats</span>
    <i id="chevronDepartment" class="fas fa-chevron-down"></i>
  </div>
  <div class="chat-list collapse show" id="departmentCollapse">
    <ul class="list-unstyled" style="max-height: 160px; overflow-y: auto;">
      <li class="p-2 mb-2 bg-white rounded-3 shadow-sm border d-flex align-items-center gap-2" style="cursor: pointer;">
        <i class="fa fa-angle-right text-muted"></i>
        <span class="text-dark fw-semibold">IT Department</span>
      </li>
      <li class="p-2 mb-2 bg-white rounded-3 shadow-sm border d-flex align-items-center gap-2" style="cursor: pointer;">
        <i class="fa fa-angle-right text-muted"></i>
        <span class="text-dark fw-semibold">HR</span>
      </li>
      <li class="p-2 mb-2 bg-white rounded-3 shadow-sm border d-flex align-items-center gap-2" style="cursor: pointer;">
        <i class="fa fa-angle-right text-muted"></i>
        <span class="text-dark fw-semibold">Marketing</span>
      </li>
    </ul>
  </div>

  <!-- Footer Section with Profile and Logout -->


</div>

<!-- Normal Chats Section -->
<div class="chat-section">
  <div class="chat-section-title d-flex justify-content-between align-items-center"
       data-bs-toggle="collapse"
       data-bs-target="#staffCollapse"
       role="button"
       aria-expanded="true"
       aria-controls="staffCollapse">
    <span>Normal Chats</span>
    <i id="chevronStaff" class="fas fa-chevron-down"></i>
  </div>
  <div class="chat-list collapse show" id="staffCollapse">
    <input type="text" id="staffSearch" class="form-control form-control-sm mb-3" placeholder="Search staff...">
    <ul class="list-unstyled" id="staffListItems" style="max-height: 300px; overflow-y: auto;">
      <!-- Dynamically added staff -->
    </ul>
  </div>
</div>

<div class="sidebar-footer mt-auto d-flex align-items-center justify-content-between p-3 border-top">
  <div class="d-flex align-items-center gap-2">
    <img src="https://via.placeholder.com/32" alt="Profile" class="rounded-circle" width="32" height="32">
    <div class="welcome-text fw-semibold fs-6 text-dark"> <span id="adminName">Admin</span></div>
  </div>
  <button id="logoutBtn" class="btn btn-sm btn-outline-danger">Logout</button>
</div>
    </div>

    <div id="chatView">
      <div id="chatHeader">
        <i class="fas fa-arrow-left back-btn" id="goBack"></i>
        <img id="chatImg" class="chat-logo" src="https://i.pravatar.cc/45?img=30"/>
        <div class="name" id="chatName">IT Dept</div>
        <div class="controls">
          <i class="fas fa-search" title="Search messages" onclick="openSearchModal()"></i>
          <i class="fas fa-video" title="Video call"></i>
          <i class="fas fa-phone" title="Voice call"></i>
        </div>
      </div>

      <div id="messages">
        <div class="message recv">Hello team!<div class="time">08:55</div></div>
        <div class="message sent">Systems are up.<div class="time">09:00</div><div class="seen-status"><i class="fa fa-check-double"></i></div></div>
      </div>

<form id="chatForm" style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9f9f9; border-radius: 10px; border: 1px solid #ddd;">
  
  <!-- Attach Icon -->
  <i class="fa fa-paperclip" title="Attach file" style="color: #aaa; font-size: 18px; cursor: pointer;"></i>

  <!-- Input with mic inside -->
  <div style="position: relative; flex-grow: 1;">
    <input
      type="text"
      id="chatInput"
      placeholder="Type a message..."
      autocomplete="off"
      style="width: 100%; padding: 10px 36px 10px 12px; border-radius: 20px; border: 1px solid #ccc; outline: none; font-size: 14px;"
    />
    <button type="button" id="recordBtn" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
      <i class="fa fa-microphone" style="color: #555;"></i>
    </button>
  </div>

  <!-- Send Button -->
  <button type="submit" style="background-color: #007bff; border: none; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
    <i class="fa fa-paper-plane"></i>
  </button>

</form>

    </div>
  </div>


      <!-- Voice Preview Modal -->
<div class="modal fade" id="voicePreviewModal" tabindex="-1" aria-labelledby="voicePreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Send Voice Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <audio id="voicePreviewPlayer" controls class="w-100"></audio>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmSendVoiceBtn" type="button" class="btn btn-primary">Send</button>
      </div>
    </div>
  </div>
</div>
  <!-- Search Modal -->
  <div id="searchModal">
    <div class="modal-content">
      <h3>Search Messages</h3>
      <input type="text" id="modalSearchInput" placeholder="Type to search..." />
      <button onclick="performSearch()">Search</button>
    </div>
  </div>

 
    <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js" integrity="sha512-AI5A3zIoeRSEEX9z3Vyir8NqSMC1pY7r5h2cE+9J6FLsoEmSSGLFaqMQw8SWvoONXogkfFrkQiJfLeHLz3+HOg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script>
  document.getElementById("toggleSidebar").addEventListener("click", function () {
    const sidebar = document.querySelector(".card.shadow-sm.rounded-4");
    sidebar.classList.toggle("d-none");
  });
</script>


<script type="module">
const departmentCollapse = document.getElementById('departmentCollapse');
const staffCollapse = document.getElementById('staffCollapse');

departmentCollapse.addEventListener('shown.bs.collapse', () => {
  document.getElementById('chevronDepartment').classList.remove('fa-chevron-right');
  document.getElementById('chevronDepartment').classList.add('fa-chevron-down');
});

departmentCollapse.addEventListener('hidden.bs.collapse', () => {
  document.getElementById('chevronDepartment').classList.remove('fa-chevron-down');
  document.getElementById('chevronDepartment').classList.add('fa-chevron-right');
});

staffCollapse.addEventListener('shown.bs.collapse', () => {
  document.getElementById('chevronStaff').classList.remove('fa-chevron-right');
  document.getElementById('chevronStaff').classList.add('fa-chevron-down');
});

staffCollapse.addEventListener('hidden.bs.collapse', () => {
  document.getElementById('chevronStaff').classList.remove('fa-chevron-down');
  document.getElementById('chevronStaff').classList.add('fa-chevron-right');
});

const BASE_URL = window.location.hostname === "localhost"
  ? "http://localhost:5000"  // Change port to your local backend port
  : "https://cardstel.onrender.com";


  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBCnkHghVzYEKhYMncwLQ-IlGLVbfIJt9U",
    authDomain: "chat-app-6776e.firebaseapp.com",
    projectId: "chat-app-6776e",
    storageBucket: "chat-app-6776e.appspot.com",
    messagingSenderId: "136411415099",
    appId: "1:136411415099:web:37f7c2c9cb4431db27121e",
    measurementId: "G-GVS3VG6Y50"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let uid = null;
  let currentUserId = null; // ‚úÖ Add this
  let receiverId = null;
  const unreadCounters = {};

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/login";
      return;
    }

    uid = user.uid;
    const token = await user.getIdToken();

    // Load profile
    try {
      const profile = await fetch(`/api/staff/profile?uid=${uid}`).then(res => res.json());
      document.getElementById('adminName').textContent = profile.name || 'Admin';

      const profileImage = document.querySelector('#profileDropdown img');
      profileImage.src = profile.profile_picture?.data
        ? `data:image/jpeg;base64,${profile.profile_picture.data}`
        : `https://i.pravatar.cc/36?u=${uid}`;
    } catch (err) {
      console.error("Error loading profile:", err);
    }

    
    // Staff list loader and first chat setup
let firstStaffId = null;
let firstStaffName = null;
try {
  const staffList = await fetch('/api/staff/all').then(res => res.json());

  // === Map Firebase UID to numeric staff ID ===
  const uidToIdMap = {};
  staffList.forEach(staff => {
    uidToIdMap[staff.firebase_uid] = staff.id;
  });

  currentUserId = uidToIdMap[uid];
  console.log("‚úÖ Firebase UID:", uid);
  console.log("‚úÖ Mapped numeric staff ID:", currentUserId);
  // === End mapping ===

  const staffListContainer = document.getElementById('staffListItems');

  const sortedStaff = staffList
    .filter(staff => staff.firebase_uid !== uid)
    .sort((a, b) => {
      const priority = { super_admin: 0, admin: 1, user: 2 };
      return (priority[a.role] ?? 3) - (priority[b.role] ?? 3);
    });

  sortedStaff.forEach((staff, index) => {
    const li = document.createElement('li');
    li.className = 'staff-item d-flex align-items-center justify-content-between p-2 rounded-3 mb-2 bg-white shadow-sm';
    li.style.cursor = 'pointer';
    li.dataset.id = staff.id;

    let profileImg = `https://i.pravatar.cc/32?u=${staff.firebase_uid}`;
    if (staff.profile_picture?.data) {
      try {
        const bufferData = staff.profile_picture.data;
        const pathStr = new TextDecoder().decode(new Uint8Array(bufferData));
        profileImg = pathStr.startsWith('/uploads') ? pathStr : `/${pathStr}`;
      } catch (imgErr) {
        console.error("Error decoding profile image:", imgErr);
      }
    }

    let badge = '';
    if (staff.role === 'super_admin') {
      badge = `<span class="badge bg-danger text-white ms-2" style="font-size:10px;">Super Admin</span>`;
    } else if (staff.role === 'admin') {
      badge = `<span class="badge bg-primary text-white ms-2" style="font-size:10px;">Admin</span>`;
    }
li.className = "staff-item"; // optional
li.innerHTML = `
  <div class="d-flex align-items-center gap-2 position-relative w-100">
    <img src="${profileImg}" alt="${staff.name}" class="rounded-circle border" width="36" height="36" />
    <div class="text-dark fw-semibold d-flex align-items-center">
      ${staff.name}
      ${badge}
    </div>
    <span class="message-counter badge bg-danger text-white position-absolute top-0 start-100 translate-middle rounded-pill" style="font-size: 0.7rem; display: none;">0</span>
  </div>
  <div class="connection-indicator text-warning"><i class="fa-solid fa-circle fa-xs"></i></div>
`;
// Add this line to open chat when the staff item is clicked
li.addEventListener('click', () => {
  openChat(staff.name, profileImg);
});

    if (index === 0) {
      li.classList.add('active');
      firstStaffId = staff.id;
      firstStaffName = staff.name;
    }

    li.addEventListener('click', () => {
      document.querySelector('#staffListItems li.active')?.classList.remove('active');
      li.classList.add('active');

      receiverId = li.dataset.id;

      // ‚úÖ Update only chat header name and image
      document.getElementById('chatName').textContent = staff.name;
      document.getElementById('chatImg').src = staff.imgUrl || "https://i.pravatar.cc/45";

      loadChatHistory(receiverId);

      unreadCounters[receiverId] = 0;
      const counter = li.querySelector('.message-counter');
      if (counter) {
        counter.textContent = '0';
        counter.style.display = 'none';
      }
    });

    staffListContainer.appendChild(li);
  });

  await loadUserDepartments();

  if (firstStaffId) {
    receiverId = firstStaffId;

    try {
      const firstStaff = sortedStaff.find(s => s.id == firstStaffId);
      if (firstStaff) {
        document.getElementById('chatName').textContent = firstStaff.name;

        let firstImg = `https://i.pravatar.cc/45?u=${firstStaff.firebase_uid}`;
        if (firstStaff.profile_picture?.data) {
          try {
            const bufferData = firstStaff.profile_picture.data;
            const pathStr = new TextDecoder().decode(new Uint8Array(bufferData));
            firstImg = pathStr.startsWith('/uploads') ? pathStr : `/${pathStr}`;
          } catch (imgDecodeErr) {
            console.error("Error decoding profile picture path:", imgDecodeErr);
          }
        }

        document.getElementById('chatImg').src = firstImg;
      }

      loadChatHistory(receiverId);
    } catch (err) {
      console.error("Error loading first staff chat:", err);
    }
  }

} catch (err) {
  console.error("‚ùå Failed to fetch staff list or initialize chat:", err);
}



// staffListContainer.appendChild(li);
function openChat(name, imgUrl) {
  // Show chat section
  document.getElementById('chatView').classList.add('active');

  // Optional: Hide staff list if you're switching views

 
  // Update header
  document.getElementById('chatName').textContent = name;
  document.getElementById('chatImg').src = imgUrl;

  // Set receiverId (you must have this available from the click context or staff object)
  if (receiverId) {
    loadChatHistory(receiverId);
  }
}

const chatView = document.getElementById('chatView');
const backButton = document.getElementById('goBack');

// Handle back button click
backButton.addEventListener('click', goBack);

// Handle go back (show staff list, hide chat view)
function goBack() {
  chatView.classList.remove("active");
}
 let startX = 0;

chatView.addEventListener('touchstart', function (e) {
  startX = e.touches[0].clientX;
});

chatView.addEventListener('touchend', function (e) {
  let endX = e.changedTouches[0].clientX;
  if (startX < 50 && endX - startX > 100) {
    goBack(); // Go back if dragged right from left edge
  }
});




    // Connect to Socket.IO
    const socket = io(BASE_URL, { auth: { token } });
    // Open or create IndexedDB
function openIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("OfflineChatDB", 1);
    request.onerror = () => reject("Failed to open DB");
    request.onsuccess = () => resolve(request.result);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      db.createObjectStore("pendingMessages", { keyPath: "id", autoIncrement: true });
    };
  });
}

// Save unsent message
async function saveMessageOffline(msgData) {
  const db = await openIndexedDB();
  const tx = db.transaction("pendingMessages", "readwrite");
  tx.objectStore("pendingMessages").add(msgData);
}

// Sync pending messages
async function syncOfflineMessages() {
  const db = await openIndexedDB();
  const tx = db.transaction("pendingMessages", "readwrite");
  const store = tx.objectStore("pendingMessages");
  const getAll = store.getAll();

  getAll.onsuccess = async () => {
    const messages = getAll.result;
    for (const msg of messages) {
      socket.emit("chat message", msg);
      store.delete(msg.id); // delete after sending
    }
  };
}


    socket.on('connect', () => console.log('‚úÖ Connected to server'));

    socket.on("online-users", (onlineUserIds) => {
  document.querySelectorAll("#staffListItems li").forEach(li => {
    const indicator = li.querySelector('.connection-indicator');
    const userId = li.dataset.id;
    if (!indicator) return;

    if (onlineUserIds.includes(Number(userId))) {
      indicator.classList.remove("text-warning");
      indicator.classList.add("text-success"); // green
    } else {
      indicator.classList.remove("text-success");
      indicator.classList.add("text-warning"); // yellow
    }
  });
});


  socket.on('chat message', (data) => {
  const chatMessages = document.getElementById('messages');

  const isCurrentChat =
    (data.sender_id == receiverId || data.receiver_id == receiverId) ||
    (data.department_id && receiverId == data.department_id);

const isSelf = Number(data.sender_id) === currentUserId;

  // üü¢ Determine message content
  const messageContent = data.message_type === 'voice' && data.file_url
    ? `<audio controls style="width: 200px;">
         <source src="${data.file_url}" type="${data.file_type}">
         Your browser does not support the audio element.
       </audio>`
    : data.content;

  const msgDiv = document.createElement('div');
  msgDiv.className = `chat-message ${isSelf ? 'sent' : 'received'}`;
  msgDiv.innerHTML = `
    <img src="https://i.pravatar.cc/36?u=${data.sender_id}" alt="User" class="rounded-circle me-2" width="36" height="36" />
    <div>
      <div class="fw-semibold">${isSelf ? 'You' : data.sender_name || 'Them'}</div>
      <div class="bg-light border rounded p-2">${messageContent}</div>
      <small class="text-muted">${new Date(data.sent_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
    </div>
  `;

  if (isCurrentChat) {
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } else {
    unreadCounters[data.sender_id] = (unreadCounters[data.sender_id] || 0) + 1;

    const userLi = document.querySelector(`#staffListItems li[data-id='${data.sender_id}']`);
    if (userLi) {
      userLi.classList.add('has-sent');
      const counter = userLi.querySelector('.message-counter');
      if (counter) {
        counter.textContent = unreadCounters[data.sender_id];
        counter.style.display = 'inline-block';
      }
    }

    if (data.department_id) {
      const deptLi = document.querySelector(`#departmentCollapse li[data-dept-id='${data.department_id}']`);
      if (deptLi) {
        deptLi.classList.add('has-sent');
      }
    }
  }
});


    document.getElementById('chatForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (!msg || !receiverId) return;

      let emitData = {
        content: msg,
        sender_id: currentUserId,
        sender_name: document.getElementById('adminName').textContent,
        chat_type: 'private',
        receiver_id: null,
        department_id: null
      };

      const isDepartment = !document.querySelector(`#departmentCollapse li[data-dept-id='${receiverId}']`);
      if (isDepartment) {
        emitData.type = 'department';
        emitData.department_id = receiverId;
      } else {
        emitData.receiver_id = receiverId;
      }

      socket.emit('chat message', emitData);

      const chatMessages = document.getElementById('messages');
      const selfMsg = document.createElement('div');
      selfMsg.className = 'chat-message sent';
      selfMsg.innerHTML = `
        <div>
          <div class="bg-light border rounded p-2">${msg}</div>
          <small class="text-muted">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</small>
        </div>
      `;
      chatMessages.appendChild(selfMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      input.value = '';
    });

    async function loadUserDepartments() {
      try {
        const res = await fetch(`/api/departments/user?uid=${uid}`);
        const departments = await res.json();
        const deptList = document.getElementById('departmentCollapse');
        deptList.innerHTML = '';

        if (departments.length === 0) {
          const li = document.createElement('li');
          li.className = 'p-2 mb-2 bg-white rounded-3 shadow-sm border text-center text-muted';
          li.textContent = 'No department added yet';
          deptList.appendChild(li);
          return;
        }

        departments.forEach((dept, index) => {
          const li = document.createElement('li');
          li.className = 'p-2 mb-2 bg-white rounded-3 shadow-sm border d-flex align-items-center gap-2';
          li.style.cursor = 'pointer';
          li.dataset.deptId = dept.id;

          li.innerHTML = `
            <i class="fa fa-angle-right text-muted"></i>
            <span class="text-dark fw-semibold">${dept.name}</span>
          `;

          li.addEventListener('click', () => {
            document.querySelectorAll('#departmentCollapse li').forEach(el => el.classList.remove('active'));
            li.classList.add('active');

            receiverId = dept.id;
            document.getElementById('chatHeader').textContent = `Department: ${dept.name}`;
            loadDepartmentChat(dept.id);
          });

          deptList.appendChild(li);
        });

        if (departments.length > 0) {
          deptList.querySelector('li').classList.add('active');
          receiverId = departments[0].id;
          document.getElementById('chatHeader').textContent = `Department: ${departments[0].name}`;
          loadDepartmentChat(departments[0].id);
        }
      } catch (err) {
        console.error('Failed to load user departments:', err);
      }
    }

let isRecording = false;
let mediaRecorder;
let audioChunks = [];
let recordedBlob = null;

const recordBtn = document.getElementById('recordBtn');
const confirmSendBtn = document.getElementById('confirmSendVoiceBtn');
const voicePreviewPlayer = document.getElementById('voicePreviewPlayer');
const voiceModal = new bootstrap.Modal(document.getElementById('voicePreviewModal'));

recordBtn.addEventListener('click', async () => {
  if (!receiverId || !currentUserId) return;

  if (!isRecording) {
    // Start recording
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = () => {
      recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
      voicePreviewPlayer.src = URL.createObjectURL(recordedBlob);
      voiceModal.show();
    };

    mediaRecorder.start();
    isRecording = true;
    recordBtn.innerHTML = '<i class="fa fa-stop"></i>';

  } else {
    // Stop and show modal
    mediaRecorder.stop();
    isRecording = false;
    recordBtn.innerHTML = '<i class="fa fa-microphone"></i>';
  }
});

confirmSendBtn.addEventListener('click', async () => {
  if (!recordedBlob) return;

  const tempUrl = URL.createObjectURL(recordedBlob);
  const messageContainer = document.getElementById('messages');

  // === 1. Show temp voice message
  const tempMsgDiv = document.createElement('div');
  tempMsgDiv.className = 'message voice sending';

  const tempAudio = new Audio(tempUrl);
  tempAudio.controls = true;

  const statusLabel = document.createElement('small');
  statusLabel.textContent = 'Sending...';
  statusLabel.className = 'sending-label';

  tempMsgDiv.appendChild(tempAudio);
  tempMsgDiv.appendChild(statusLabel);
  messageContainer.appendChild(tempMsgDiv);

  socket.emit('chat message', {
    content: 'voice message',
    file_url: tempUrl,
    file_type: 'audio/webm',
    file_name: 'voice-message.webm',
    message_type: 'voice',
    sender_id: currentUserId,
    receiver_id: receiverId,
    sender_name: document.getElementById('adminName').textContent,
    chat_type: 'private',
    is_temp: true,
  });

  const formData = new FormData();
  formData.append('file', recordedBlob, 'voice-message.webm');
  formData.append('sender_id', currentUserId);
  formData.append('receiver_id', receiverId);
  formData.append('chat_type', 'private');

  try {
    const res = await fetch('/api/messages/send/voice', {
      method: 'POST',
      body: formData,
    });

    const result = await res.json();

    // Replace blob audio with final audio (with retry if needed)
    const finalAudio = new Audio();
    finalAudio.controls = true;

    finalAudio.addEventListener('error', () => {
      console.warn('Audio failed to load, retrying...');
      setTimeout(() => {
        finalAudio.src = result.file_url + '?t=' + Date.now(); // force re-fetch
        finalAudio.load();
      }, 1000);
    });

    finalAudio.src = result.file_url;

    tempMsgDiv.innerHTML = '';
    tempMsgDiv.classList.remove('sending');
    tempMsgDiv.appendChild(finalAudio);

    socket.emit('chat message', {
      content: 'voice message',
      file_url: result.file_url,
      file_type: result.file_type,
      file_name: result.file_name,
      message_type: 'voice',
      sender_id: currentUserId,
      receiver_id: receiverId,
      sender_name: document.getElementById('adminName').textContent,
      chat_type: 'private',
    });

  } catch (err) {
    console.error('Upload failed:', err);
    statusLabel.textContent = 'Upload failed';
    statusLabel.style.color = 'red';
  }

  voiceModal.hide();
  recordedBlob = null;
});



async function loadDepartmentChat(departmentId) {
  if (!uid) return;
  try {
    const response = await fetch(`/api/messages?type=department&department_id=${departmentId}`);
    const messages = await response.json();

    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';

    for (const msg of messages) {
      const isSelf = Number(msg.sender_id) === currentUserId;

      const profileImg = msg.sender_profile
        ? `data:image/jpeg;base64,${msg.sender_profile}`
        : `https://i.pravatar.cc/36?u=${msg.sender_id}`;

      const messageContent = msg.message_type === 'voice' && msg.file_url
        ? `<audio controls style="width: 200px;">
             <source src="${msg.file_url}" type="${msg.file_type || 'audio/webm'}">
             Your browser does not support the audio element.
           </audio>`
        : msg.content;

      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${isSelf ? 'sent' : 'received'}`;
      messageDiv.innerHTML = `
        <img src="${profileImg}" alt="${isSelf ? 'You' : 'User'}" class="rounded-circle me-2" width="36" height="36" />
        <div>
          <div class="fw-semibold">${isSelf ? 'You' : msg.sender_name || 'Unknown'}</div>
          <div class="bg-light border rounded p-2">${messageContent}</div>
          <small class="text-muted">${new Date(msg.sent_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
        </div>
      `;
      chatMessages.appendChild(messageDiv);
    }

    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch (err) {
    console.error('Failed to load department chat:', err);
  }
}

   
 async function loadChatHistory(withUserId) {
  if (!uid) {
    console.warn('‚ö†Ô∏è loadChatHistory called but uid is null or undefined');
    return;
  }

  try {
    const response = await fetch(`/api/messages?type=private&user_id=${withUserId}`);
    const messages = await response.json();

    const chatMessages = document.getElementById('messages'); // Use "messages" as you wanted
    chatMessages.innerHTML = '';

    for (const msg of messages) {
      const isSelf = Number(msg.sender_id) === currentUserId;

      const messageContent = msg.message_type === 'voice' && msg.file_url
        ? `<audio controls style="width: 200px;">
             <source src="${msg.file_url}" type="${msg.file_type || 'audio/webm'}">
             Your browser does not support the audio element.
           </audio>`
        : msg.content;

      const sentTime = msg.sent_at
        ? new Date(msg.sent_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : '';

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isSelf ? 'sent' : 'recv'}`;
      messageDiv.innerHTML = `
        ${messageContent}
        <div class="time">${sentTime}</div>
        ${isSelf ? '<div class="seen-status"><i class="fa fa-check-double"></i></div>' : ''}
      `;

      chatMessages.appendChild(messageDiv);
    }

    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch (err) {
    console.error('‚ùå Failed to load chat history:', err);
  }
}


  });
</script>
</body>
</html>
