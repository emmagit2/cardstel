
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />


  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }

    #topNav {
      height: 56px;
      background-color: #1e293b;
      color: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.2);
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
    }

    #topNav .welcome-text {
      font-weight: 600;
      font-size: 1.1rem;
    }

    #profileDropdown {
      color: #f1f5f9;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
      position: relative;
    }

    #profileDropdown img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }

    #profileDropdown .caret {
      border-top: 5px solid #f1f5f9;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      display: inline-block;
      margin-left: 0.2rem;
    }

    #notificationBell {
      position: relative;
      font-size: 1.3rem;
      margin-right: 1rem;
      cursor: pointer;
      color: #f1f5f9;
    }

    .notif-badge {
      background-color: #ef4444;
      color: white;
      border-radius: 50%;
      font-size: 0.7rem;
      padding: 2px 6px;
      font-weight: 700;
      position: absolute;
      top: -6px;
      right: -8px;
      user-select: none;
    }

    #sidebar {
      position: fixed;
      top: 56px;
      left: 0;
      bottom: 0;
      width: 260px;
      background-color: #111827;
      color: #e0e7ff;
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow-y: auto;
      z-index: 999;
    }

    #sidebar h5 {
      margin-bottom: 0.75rem;
      font-weight: 700;
      border-bottom: 1px solid #374151;
      padding-bottom: 0.3rem;
    }

    .section {
      margin-bottom: 2rem;
    }

    .list-group-item {
      background: transparent;
      border: none;
      color: #cbd5e1;
      padding-left: 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s ease;
      border-radius: 6px;
    }

    .list-group-item:hover {
      background-color: #374151;
    }

    .list-group-item.active {
      background-color: #2563eb;
      color: white;
    }

    #mainContent {
      margin-left: 260px;
      margin-top: 56px;
      padding: 1.5rem;
      height: calc(100vh - 56px);
      background: #f1f5f9;
      display: flex;
      gap: 1rem;
      overflow: hidden;
    }

    #staffList {
      width: 280px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #staffList h4 {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      margin: 0;
      font-weight: 600;
    }

    #staffList ul {
      list-style: none;
      margin: 0;
      padding: 0;
      flex-grow: 1;
      overflow-y: auto;
    }

    #staffList li {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: background-color 0.2s;
    }

    #staffList li:hover,
    #staffList li.active {
      background-color: #2563eb;
      color: white;
    }

    #staffList li img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    #chatUI {
      flex-grow: 1;
      background: white;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      overflow: hidden;
    }

    #chatHeader {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      font-weight: 600;
      background-color: #2563eb;
      color: white;
    }

    #chatMessages {
      flex-grow: 1;
      padding: 1rem;
      overflow-y: auto;
      background-color: #f9fafb;
    }

    .chat-message {
      margin-bottom: 1rem;
      max-width: 70%;
      padding: 0.5rem 1rem;
      border-radius: 15px;
      background-color: #e0e7ff;
    }

    .chat-message.admin {
      background-color: #2563eb;
      color: white;
      margin-left: auto;
    }

    #chatForm {
      border-top: 1px solid #ddd;
      padding: 0.5rem 1rem;
      display: flex;
      gap: 0.5rem;
    }

    #chatForm input[type="text"] {
      flex-grow: 1;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 1px solid #ccc;
      outline: none;
    }

    #chatForm button {
      padding: 0 1.5rem;
      border-radius: 20px;
    }
  </style>

</head>
<body>
  <!-- Top Navbar -->
  <nav id="topNav">
    <div class="welcome-text">Welcome, <span id="adminName">Admin</span></div>
    <div class="d-flex align-items-center">
      <div id="notificationBell"><i class="fa-solid fa-bell"></i><span class="notif-badge" style="display:none">3</span></div>
      <div id="profileDropdown" data-bs-toggle="dropdown"><img src="https://i.pravatar.cc/36" alt="Profile Picture"><span>Admin</span><span class="caret"></span></div>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="#">Profile</a></li>
        <li><a class="dropdown-item" href="#">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="section">
      <h5><i class="fa-solid fa-building"></i> Departments</h5>
      <ul class="list-group" id="departmentList"></ul>
      <button class="btn btn-primary btn-sm w-100 mt-2"><i class="fa-solid fa-plus"></i> Add Department</button>
    </div>
    <div class="section">
      <h5><i class="fa-solid fa-user-check"></i> Approve Members <span class="notif-badge" id="unapprovedCount" style="display:none">0</span></h5>
      <ul class="list-group" id="unapprovedMembersList"></ul>
    </div>
  </aside>

  <!-- Main Content -->
  <main id="mainContent">
    <div id="staffList">
      <h4>Staff</h4>
      <ul id="staffListItems"></ul>
    </div>
    <div id="chatUI">
      <div id="chatHeader">Chat with</div>
      <div id="chatMessages"></div>
      <form id="chatForm">
        <input type="text" id="chatInput" placeholder="Type a message..." />
        <button type="submit" class="btn btn-primary">Send</button>
      </form>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js" integrity="sha512-AI5A3zIoeRSEEX9z3Vyir8NqSMC1pY7r5h2cE+9J6FLsoEmSSGLFaqMQw8SWvoONXogkfFrkQiJfLeHLz3+HOg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBCnkHghVzYEKhYMncwLQ-IlGLVbfIJt9U",
    authDomain: "chat-app-6776e.firebaseapp.com",
    projectId: "chat-app-6776e",
    storageBucket: "chat-app-6776e.firebasestorage.app",
    messagingSenderId: "136411415099",
    appId: "1:136411415099:web:37f7c2c9cb4431db27121e",
    measurementId: "G-GVS3VG6Y50"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let receiverId = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/login";
      return;
    }

    const uid = user.uid;
    const token = await user.getIdToken();

    try {
      const profile = await fetch(`/api/staff/profile?uid=${uid}`)
        .then(res => res.json());

      document.getElementById('adminName').textContent = profile.name || 'Admin';

      const profileImage = document.querySelector('#profileDropdown img');
      profileImage.src = profile.profile_picture || `https://i.pravatar.cc/36?u=${uid}`;
    } catch (err) {
      console.error('Error fetching profile:', err);
    }

    const socket = io('http://localhost:5000', {
      auth: { token }
    });

    socket.on('connect', () => console.log('âœ… Connected to server'));

    socket.on('chat message', (data) => {
      const chatMessages = document.getElementById('chatMessages');
      const msg = document.createElement('div');
      msg.className = 'chat-message';
      msg.textContent = `${data.sender_id}: ${data.content}`;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    document.getElementById('chatForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (!msg || !receiverId) return;

      socket.emit('chat message', {
        content: msg,
        type: 'private',
        receiver_id: receiverId,  // numeric id now
        departmentId: null
      });

      const chatMessages = document.getElementById('chatMessages');
      const selfMsg = document.createElement('div');
      selfMsg.className = 'chat-message admin';
      selfMsg.textContent = msg;
      chatMessages.appendChild(selfMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      input.value = '';
    });

    const staffList = await fetch('/api/staff/all')
      .then(res => res.json())
      .catch(err => {
        console.error('Failed to fetch staff:', err);
        return [];
      });

    const staffListContainer = document.getElementById('staffListItems');
    staffList.forEach((staff, index) => {
      const li = document.createElement('li');
      li.dataset.id = staff.id;  // <-- use numeric DB id here
      li.innerHTML = `<img src="${staff.profile_picture || 'https://i.pravatar.cc/32?u=' + staff.firebase_uid}"> ${staff.name}`;

      if (index === 0) {
        li.classList.add('active');
        receiverId = staff.id;  // <-- use numeric DB id here
        document.getElementById('chatHeader').textContent = `Chat with ${staff.name}`;
      }

      li.addEventListener('click', () => {
        document.querySelector('#staffListItems li.active')?.classList.remove('active');
        li.classList.add('active');
        receiverId = li.dataset.id;  // <-- numeric DB id again
        document.getElementById('chatHeader').textContent = `Chat with ${staff.name}`;
        document.getElementById('chatMessages').innerHTML = '';
      });

      staffListContainer.appendChild(li);
    });
  });
</script>




</body>
</html>
